# AKS Cheatsheet - ${cluster_name}

This cheatsheet was generated by Terraform. It includes common commands to connect to the cluster, install the managed NGINX ingress (Application Routing add-on custom resource), apply ServiceAccounts for Workload Identity, and verify connectivity.

> Assumptions
> - You have Azure CLI and kubectl installed.
> - You're logged in to the correct subscription.

---

## Connect to the cluster

```bash
# Merge admin kubeconfig
az aks get-credentials \
  --resource-group ${resource_group} \
  --name ${aks_name} \
  --admin

# (Optional) use kubectx to switch contexts
kubectx ${aks_name}
```

## Apply ServiceAccount for Azure Workload Identity

```bash
# ServiceAccount (namespace: ${app_namespace})
kubectl apply -f infra/k8s/generated/${cluster_key}-serviceaccount.yaml

# Verify
kubectl -n ${app_namespace} get sa ${service_account_name} -o yaml | yq '.metadata.annotations'
```

## Install NGINX Ingress Controller (Application Routing add-on CRD)

```bash
# NginxIngressController (namespace: app-routing-system)
kubectl apply -f infra/k8s/generated/${cluster_key}-nginx-internal-controller.yaml

# Verify service gets the static internal IP
kubectl get svc -n app-routing-system -l app.kubernetes.io/component=controller -o wide
```

### Expected IP (from Terraform)
- Static internal IP: ${nginx_internal_ip}
- Subnet name: ${subnet_name}

## Quick checks for Workload Identity token injection

```bash
# Example: exec into a pod and grab a token (adjust deployment/name as needed)
kubectl -n ${app_namespace} exec -it deploy/<your-deployment> -- env | grep AZURE_CLIENT_ID
kubectl -n ${app_namespace} exec -it deploy/<your-deployment> -- printenv | grep -e AZURE_TENANT_ID
```

## App Gateway smoke tests

```bash
# Resolve and curl the Application Gateway public endpoint
AGW_IP=${app_gw_ip}

# Simple HTTP/HTTPS requests
curl -sS http://$AGW_IP -v | head -n 20
curl -sS https://$AGW_IP -k -v | head -n 20

# (Optional) host header for a specific backend
curl -sS -H 'Host: ${public_host}' https://$AGW_IP -k -v | head -n 40
```

## Useful Terraform outputs

```bash
# Show important outputs in JSON for scripting
terraform output -json aks_clusters | jq -r '."${cluster_key}"'
terraform output -json nginx_ingress_config | jq -r '."${cluster_key}"'
terraform output -json service_account_manifest_files | jq -r '."${cluster_key}"'
terraform output -json nginx_controller_manifest_files | jq -r '."${cluster_key}"'
```

---

## Clean up

```bash
# Remove applied Kubernetes resources when needed
kubectl delete -f infra/k8s/generated/${cluster_key}-nginx-internal-controller.yaml || true
kubectl -n ${app_namespace} delete -f infra/k8s/generated/${cluster_key}-serviceaccount.yaml || true
```
